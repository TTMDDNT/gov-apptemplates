function openSidePane(context, title, customPageName, icon, isSelected = true, width = 400, hideHeader = false) {
    openPane(context, isSelected, title, customPageName, icon, width, hideHeader);
    registerClosePanes(context);
};

function openPane(context, isSelected, title, customPageName, icon, width = 400, hideHeader = false) {
    const formContext = getFormContext(context);
    function createPane() {
        let entityName = formContext.data.entity.getEntityName();
        entityName += "s";
        let recordId = formContext.data.entity.getId().replace(/[\{\}]/g, '');

        Xrm.App.sidePanes.createPane({
            title,
            imageSrc: icon,
            paneId: title,
            hideHeader,
            canClose: true,
            width,
            isSelected
        }).then((pane) => {
            setTimeout(
                pane.navigate({
                    pageType: "custom",
                    name: customPageName,
                    entityName,
                    recordId
                }),
                2000
            );
        });

        // Add title to the array if not already present
        if (!openedPaneTitles.includes(title)) {
            openedPaneTitles.push(title);
        }

        startStateManagement(context);
    }

    const pane = Xrm.App.sidePanes.getPane(title);
    if (pane) {
        pane.close().then(createPane);
    } else {
        createPane();
    }
};

var isStateManaged = false;

function startStateManagement(context) {
	if (isStateManaged) return;
	setCustomPageState(context);
	isStateManaged = true;
	intervalId = setInterval(() => setCustomPageState(context), 3000);
};

function getFormContext(context) {
	return context.getFormContext ? context.getFormContext() : context;
};

function setCustomPageState(context) {
	const formContext = getFormContext(context);
	const uniqueValue = new Date().toISOString();
	formContext.getAttribute("msgov_custompagestate").setValue(uniqueValue);
};

function registerClosePanes(context) {
	const formContext = getFormContext(context);
	formContext.data.entity.addOnSave(handleOnSaveEvent);
};

// Track opened pane titles
var openedPaneTitles = [];

// Enhanced closeSidePanes to close all tracked panes
function closeSidePanes() {
    // Close all panes whose titles are in the array
    openedPaneTitles.forEach(function(title) {
        var pane = Xrm.App.sidePanes.getPane(title);
        if (pane) {
            pane.close();
        }
    });
    // Clear the array after closing
    openedPaneTitles = [];
}

function handleOnSaveEvent(context) {
	const formContext = getFormContext(context);
	formContext.getAttribute("msgov_custompagestate").setValue("");
	const saveMode = context.getEventArgs().getSaveMode();
	if (saveMode === 2) closeSidePanes();
	else setCustomPageState(context);
};

// open a custom page as a panel
function openCustomPageAsPanel(title, customPageName, entityName, recordId, width = 200, hideHeader = false) {
	// console.log("ID: " + selectedItemId);
	Xrm.App.sidePanes
		.createPane({
			title: title,
			paneId: title,
			hideHeader: hideHeader,
			canClose: true,
			width: width,
		})
		.then((pane) => {
			setTimeout(
				pane.navigate({
					pageType: "custom",
					name: customPageName,
					entityName: entityName,
					recordId: recordId,
				}),
				2000
			);
		});
};

function openCustomPageAsDialog(title, customPageName, entityName, recordId, widthPercent = 60,) {
	// Centered Dialog
	var pageInput = {
		pageType: "custom",
		name: customPageName,
		entityName: entityName,
		recordId: recordId,
	};
	var navigationOptions = {
		target: 2,
		position: 1,
		width: { value: widthPercent, unit: "%" },
		title: title
	};
	Xrm.Navigation.navigateTo(pageInput, navigationOptions)
		.then(
			function () {
				// Called when the dialog closes
			}
		).catch(
			function (error) {
				// Handle error
			}
		);
}

function openCustomPageAsPanelViaLookup(title, customPageName, entityName, primaryControl, lookupControlName, width = 200, hideHeader = false) {
	// console.log("ID: " + selectedItemId);
	var formContext = primaryControl;
	var recordId = getLookupValue(formContext, lookupControlName);
	Xrm.App.sidePanes
		.createPane({
			title: title,
			paneId: title,
			hideHeader: hideHeader,
			canClose: true,
			width: width,
		})
		.then((pane) => {
			setTimeout(
				pane.navigate({
					pageType: "custom",
					name: customPageName,
					entityName: entityName,
					recordId: recordId,
				}),
				2000
			);
		});
};

function getLookupValue(formContext, controlName) {
	var lookupField = formContext.getAttribute(controlName);

	if (lookupField) {
		var lookupValue = lookupField.getValue(); // Get the lookup value
		if (lookupValue && lookupValue.length > 0) {
			var recordId = lookupValue[0].id; // Get the ID of the first selected record
			//console.log("Selected record ID: " + recordId);
			var recordId = recordId.replace(/[\{\}]/g, ''); // Remove curly braces
			return recordId;
		} else {
			//console.log("No record is selected in the lookup.");
			return null; // No record selected
		}
	} else {
		//console.log("Lookup field not found on the form.");
		return null; // Field not found on the form
	}
}

function scrubHTMLFromRichTextControl(formContext, controlName) {
    // Get the control value
    var controlValue = formContext.getAttribute(controlName).getValue();

    // Function to remove HTML tags
    function stripHTML(html) {
        var div = document.createElement("div");
        div.innerHTML = html;
        return div.textContent || div.innerText || "";
    }

    // Scrub the HTML from the control value
    var scrubbedValue = stripHTML(controlValue);

    // Set the scrubbed value back to the control
    formContext.getAttribute(controlName).setValue(scrubbedValue);
    formContext.getAttribute(controlName).setSubmitMode("always");
}

function scrubHTMLFromRichText(executionContext) {
    // Get the form context
    var formContext = executionContext.getFormContext();

    // Get the control that triggered the event
    var control = executionContext.getEventSource();
    var controlName = control.getName();

    // Call the helper function
    scrubHTMLFromRichTextControl(formContext, controlName);
}